<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebAR with NFT Marker and Video</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
        }

        #info {
            @apply absolute top-4 left-4 bg-gray-900 text-white p-4 rounded-lg z-50 shadow-lg;
            background: rgba(0,0,0,0.7);
        }

        #debug {
            @apply absolute bottom-4 left-4 bg-red-800 text-white p-2 rounded-lg z-50 text-xs shadow-lg;
            background: rgba(255,0,0,0.7);
        }
    </style>
</head>
<body>
    <div id="info">
        <p class="font-bold">Point your camera at the NFT marker image</p>
        <p class="text-sm mt-1">Status: <span id="status">Loading...</span></p>
    </div>

    <div id="debug">
        <p>Debug: <span id="debug-text">Initializing...</span></p>
    </div>

    <a-scene
        vr-mode-ui="enabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        embedded
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    >
        <a-assets>
            <video
                id="video"
                src="veilshort2.mp4"
                preload="auto"
                loop
                crossorigin="anonymous"
                webkit-playsinline
                playsinline
                muted
            ></video>
        </a-assets>

        <a-nft
            type="nft"
            url="https://cdn.glitch.global/c3f7360c-25a8-4447-a87f-132e0129f122/veil?v=1719541243555"
            smooth="true"
            smoothCount="10"
            smoothTolerance="0.01"
            smoothThreshold="5"
            id="nft-marker"
            emitevents="true"
            registerevents="true"
        >
            <a-plane
                id="video-plane"
                position="0 0 0"
                rotation="-90 0 0"
                width="1.778"
                height="1"
                material="src: #video; transparent: true; alphaTest: 0.1; opacity: 1;"
                visible="false"
            ></a-plane>
        </a-nft>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.querySelector('#video');
            const marker = document.querySelector('#nft-marker');
            const videoPlane = document.querySelector('#video-plane');
            const statusElement = document.querySelector('#status');
            const debugElement = document.querySelector('#debug-text');

            let markerFound = false;

            const updateStatus = (status) => {
                statusElement.textContent = status;
                console.log(`Status: ${status}`);
            };

            const updateDebug = (message) => {
                debugElement.textContent = message;
                console.log(`Debug: ${message}`);
            };

            if (marker && video && videoPlane) {
                marker.addEventListener('markerFound', () => {
                    updateStatus('Marker detected - Playing video');
                    updateDebug('Marker found - Video should play');
                    markerFound = true;

                    videoPlane.setAttribute('visible', true);
                    
                    video.play().then(() => {
                        updateDebug(`Video playing - Duration: ${video.duration}s`);
                    }).catch(error => {
                        updateDebug('Video play failed: ' + error.message);
                        console.error('Video play failed:', error);
                    });
                });

                marker.addEventListener('markerLost', () => {
                    updateStatus('Marker lost - Video paused');
                    updateDebug('Marker lost - Video paused');
                    markerFound = false;
                    
                    videoPlane.setAttribute('visible', false);
                    video.pause();
                });
            } else {
                updateDebug('ERROR: One or more elements not found');
            }

            document.addEventListener('click', () => {
                if (video.paused && markerFound) {
                    video.play().catch(e => {
                        updateDebug('Touch play failed: ' + e.message);
                        console.error('Touch play failed:', e);
                    });
                }
            }, { once: true });

            video.addEventListener('loadeddata', () => {
                updateStatus('Video loaded - Ready to scan');
                updateDebug('Video loaded successfully');
            });

            video.addEventListener('error', (e) => {
                updateDebug('Video error: ' + (e.message || e.srcElement.error.message));
                console.error('Video error:', e);
            });
        });
    </script>
</body>
</html>
