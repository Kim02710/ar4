<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebAR with NFT Marker and Video</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 100;
            font-family: Arial, sans-serif;
        }
        #debug {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
            font-family: Arial, sans-serif;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="info">
        Point your camera at the NFT marker image<br>
        <small>Status: <span id="status">Loading...</span></small>
    </div>
    
    <div id="debug">
        Debug: <span id="debug-text">Initializing...</span>
    </div>

    <a-scene
        vr-mode-ui="enabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        embedded
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    >
        <!-- FIXED: Move assets before using them -->
        <a-assets>
            <video
                id="video"
                src="veilvideo.mp4"
                preload="auto"
                loop
                crossorigin="anonymous"
                webkit-playsinline
                playsinline
                muted
                autoplay="false"
            ></video>
        </a-assets>

        <!-- FIXED: Added markerhandler component and proper structure -->
       <a-nft
    type="nft"
    url="ar4/veil"
    smooth="true"
    smoothCount="10"
    smoothTolerance="0.01"
    smoothThreshold="5"
    markerhandler
    id="nft-marker"
>
    <!-- Video plane laying flat on top of the marker with original aspect ratio -->
    <a-plane
        id="video-plane"
        position="0 0.001 0"
        rotation="-90 0 0"
        width="150"  
        height="150"
        material="src: #video; transparent: true; alphaTest: 0.5; opacity: 1; side: double;"
        visible="true"
        animation__show="property: material.opacity; from: 0; to: 1; dur: 1000; startEvents: markerFound"
        animation__hide="property: material.opacity; from: 1; to: 0; dur: 500; startEvents: markerLost"
    ></a-plane>
    
    <!-- Debug sphere to confirm marker detection -->
    <a-sphere
        position="0 0.5 0"
        radius="0.1"
        color="red"
        animation__bounce="property: position; to: 0 0.7 0; dir: alternate; loop: true; dur: 1000"
        visible="true"
    ></a-sphere>
</a-nft>
    <!-- Debug sphere to confirm marker detection -->
    <a-sphere
        position="0 0 3"
        radius="0.5"
        color="red"
        animation__bounce="property: position; to: 0 0 4; dir: alternate; loop: true; dur: 1000"
        visible="true"
    ></a-sphere>
</a-nft>
            
            <!-- Debug sphere to confirm marker detection -->
            <a-sphere
                position="0 0 3"
                radius="0.5"
                color="red"
                animation__bounce="property: position; to: 0 0 4; dir: alternate; loop: true; dur: 1000"
                visible="true"
            ></a-sphere>
        </a-nft>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // FIXED: Correct video element reference
        const video = document.querySelector('#video');
        const marker = document.querySelector('#nft-marker');
        const statusElement = document.querySelector('#status');
        const debugElement = document.querySelector('#debug-text');
        
        let markerFound = false;

        // FIXED: Proper event listeners with error handling
        if (marker) {
            marker.addEventListener('markerFound', () => {
                console.log('Marker found!');
                markerFound = true;
                statusElement.textContent = 'Marker detected - Playing video';
                debugElement.textContent = 'Marker found - Video should play';
                
                // Make planes visible and start video
                const videoPlane = document.querySelector('#video-plane');
                const videoPlane2 = document.querySelector('#video-plane-2');
                const videoPlane3 = document.querySelector('#video-plane-3');
                
                if (videoPlane) {
                    videoPlane.setAttribute('visible', true);
                    videoPlane.setAttribute('material', 'opacity', 1);
                }
                if (videoPlane2) {
                    videoPlane2.setAttribute('visible', true);
                    videoPlane2.setAttribute('material', 'opacity', 1);
                }
                if (videoPlane3) {
                    videoPlane3.setAttribute('visible', true);
                    videoPlane3.setAttribute('material', 'opacity', 0.9);
                }
                
                if (video) {
                    // Reset video to beginning
                    video.currentTime = 0;
                    video.play().then(() => {
                        console.log('Video playing successfully');
                        debugElement.textContent = `Video playing - Duration: ${video.duration}s`;
                    }).catch(error => {
                        console.error('Video play failed:', error);
                        debugElement.textContent = 'Video play failed: ' + error.message;
                    });
                } else {
                    debugElement.textContent = 'Video element not found';
                }
            });

            marker.addEventListener('markerLost', () => {
                console.log('Marker lost!');
                markerFound = false;
                statusElement.textContent = 'Marker lost - Video paused';
                debugElement.textContent = 'Marker lost - Video paused';
                
                // Hide planes
                const videoPlane = document.querySelector('#video-plane');
                const videoPlane2 = document.querySelector('#video-plane-2');
                const videoPlane3 = document.querySelector('#video-plane-3');
                
                if (videoPlane) videoPlane.setAttribute('material', 'opacity', 0);
                if (videoPlane2) videoPlane2.setAttribute('material', 'opacity', 0);
                if (videoPlane3) videoPlane3.setAttribute('material', 'opacity', 0);
                
                if (video) {
                    video.pause();
                }
            });
        } else {
            debugElement.textContent = 'ERROR: Marker element not found';
        }

        // FIXED: Proper component registration with error handling
        AFRAME.registerComponent('markerhandler', {
            init: function () {
                console.log('Markerhandler component initialized');
                debugElement.textContent = 'Markerhandler initialized';
                
                this.el.addEventListener('markerFound', () => {
                    console.log('markerFound event triggered');
                    var check = this.el.getAttribute("url");
                    console.log('Marker URL:', check);
                    debugElement.textContent = 'Marker found: ' + check;
                });
                
                this.el.addEventListener('markerLost', () => {
                    console.log('markerLost event triggered');
                    debugElement.textContent = 'Marker lost';
                });
            }
        });

        // Additional debugging
        video.addEventListener('loadeddata', () => {
            console.log('Video loaded');
            statusElement.textContent = 'Video loaded - Ready to scan';
            debugElement.textContent = 'Video loaded successfully';
        });

        video.addEventListener('error', (e) => {
            console.error('Video error:', e);
            debugElement.textContent = 'Video error: ' + e.message;
        });

        // Check if NFT files exist
        window.addEventListener('load', () => {
            statusElement.textContent = 'Checking NFT files...';
            
            // Try to fetch NFT files to check if they exist
            const nftPath = 'ar4/veil';
            const filesToCheck = ['.fset', '.fset3', '.iset'];
            
            let filesChecked = 0;
            let filesFound = 0;
            
            filesToCheck.forEach(ext => {
                fetch(nftPath + ext)
                    .then(response => {
                        filesChecked++;
                        if (response.ok) {
                            filesFound++;
                            console.log(`Found: ${nftPath}${ext}`);
                        } else {
                            console.error(`Missing: ${nftPath}${ext}`);
                        }
                        
                        if (filesChecked === 3) {
                            if (filesFound === 3) {
                                statusElement.textContent = 'All NFT files found - Ready to scan';
                                debugElement.textContent = 'All NFT files loaded';
                            } else {
                                statusElement.textContent = `Missing ${3-filesFound} NFT files`;
                                debugElement.textContent = `ERROR: Missing NFT files (${filesFound}/3)`;
                            }
                        }
                    })
                    .catch(error => {
                        filesChecked++;
                        console.error(`Error checking ${nftPath}${ext}:`, error);
                        
                        if (filesChecked === 3) {
                            statusElement.textContent = 'Error checking NFT files';
                            debugElement.textContent = 'ERROR: Cannot check NFT files';
                        }
                    });
            });
        });

        // Mobile tap to play fallback
        document.addEventListener('touchstart', () => {
            if (markerFound && video && video.paused) {
                video.play().catch(e => console.log('Touch play failed:', e));
            }
        }, { once: true });

        // Maintain video's original aspect ratio when it loads
video.addEventListener('loadedmetadata', function() {
    const videoPlane = document.querySelector('#video-plane');
    if (videoPlane && video.videoWidth && video.videoHeight) {
        const aspectRatio = video.videoWidth / video.videoHeight;
        const baseSize = 2; // Base size we set above
        
        // Adjust width or height based on aspect ratio
        if (aspectRatio > 1) {
            // Landscape video
            videoPlane.setAttribute('width', baseSize * aspectRatio);
            videoPlane.setAttribute('height', baseSize);
        } else {
            // Portrait or square video
            videoPlane.setAttribute('width', baseSize);
            videoPlane.setAttribute('height', baseSize / aspectRatio);
        }
        
        console.log('Video aspect ratio maintained:', aspectRatio);
        debugElement.textContent = 'Video aspect ratio maintained: ' + aspectRatio.toFixed(2);
    }
});
    </script>
</body>
</html>



